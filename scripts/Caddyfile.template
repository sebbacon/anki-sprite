# ============================================================================
# AUTHENTICATION CREDENTIALS - DO NOT CHANGE
# ============================================================================
# These credentials are used by external integrations and changing them
# will break automated systems. Contact the system administrator before
# making any modifications.
#
# Basic Auth:
#   Username: ${ANKI_AUTH_USERNAME}
#   Password: (see .env file)
#
# API Key (use as X-API-Key header):
#   (see .env file)
#
# ============================================================================

:3000 {
    # API Key authentication (checked first)
    @apikey header X-API-Key ${ANKI_API_KEY}

    # Basic auth for requests without valid API key
    @nokey not header X-API-Key ${ANKI_API_KEY}
    basicauth @nokey {
        ${ANKI_AUTH_USERNAME} ${ANKI_AUTH_PASSWORD_HASH}
    }

    # Error handling - different responses for API vs browser requests
    handle_errors {
        # API endpoints get JSON error response
        @api_startup expression {err.status_code} in [502, 503, 504] && {http.request.orig_uri.path}.startsWith("/anki-api/")
        handle @api_startup {
            header Content-Type application/json
            respond `{"error": "Service starting up. Please retry in a few seconds.", "status": "starting", "code": 503}` 503
        }

        # MCP endpoints get JSON error response
        @mcp_startup expression {err.status_code} in [502, 503, 504] && {http.request.orig_uri.path}.startsWith("/mcp/")
        handle @mcp_startup {
            header Content-Type application/json
            respond `{"error": "Service starting up. Please retry in a few seconds.", "status": "starting", "code": 503}` 503
        }

        # Browser/UI requests get friendly loading page
        @ui_startup expression {err.status_code} in [502, 503, 504]
        handle @ui_startup {
            root * /etc/caddy
            rewrite * /loading.html
            file_server
        }

        # Default error response for other errors
        respond "{err.status_code} {err.status_text}"
    }

    # Startup health check - proxies to AnkiConnect to verify Anki is fully loaded
    handle /startup/health {
        reverse_proxy anki-desktop:8765
    }

    # Startup loading page - can be accessed directly for testing
    handle /startup/loading {
        root * /etc/caddy
        rewrite * /loading.html
        file_server
    }

    # MCP schema endpoint (static file)
    handle /mcp/schema.json {
        root * /etc/caddy
        rewrite * /mcp-schema.json
        file_server
    }

    # MCP Server endpoints (SSE transport)
    handle /mcp/* {
        uri strip_prefix /mcp
        reverse_proxy host.docker.internal:8766
    }

    # Anki REST API (OpenAPI-compatible for ChatGPT)
    handle /anki-api/* {
        uri strip_prefix /anki-api
        reverse_proxy host.docker.internal:8767
    }

    # Anki Desktop UI (default)
    handle {
        reverse_proxy anki-desktop:3000
    }
}

:3001 {
    # API Key authentication (checked first)
    @apikey header X-API-Key ${ANKI_API_KEY}

    # Basic auth for requests without valid API key
    @nokey not header X-API-Key ${ANKI_API_KEY}
    basicauth @nokey {
        ${ANKI_AUTH_USERNAME} ${ANKI_AUTH_PASSWORD_HASH}
    }

    reverse_proxy host.docker.internal:8766
}
